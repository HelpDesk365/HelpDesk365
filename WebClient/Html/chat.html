
<!DOCTYPE html> 
<html>
	<head> 
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title> 
	<link href="/Assets/css/style.css" rel="stylesheet">
	<script src="/Assets/js/jquery-1.11.2.min.js"></script>
	<script src="/Assets/js/common.js"></script>    
    <!--Reference the SignalR library. -->
    <script src="/Assets/js/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://helpdesk.hunet.co.kr:8080/signalr/hubs"></script>
    <script type="text/javascript">       
       
        $(function () {
            var nickName = getQueryParameter("nickName");
            var categoryCd = getQueryParameter("categoryCd");
            var clientId = getQueryParameter("cid");
            var group = '';
            //Set the hubs URL for the connection
            $.connection.hub.url = "http://helpdesk.hunet.co.kr:8080/signalr";

            // Declare a proxy to reference the hub.
            var chat = $.connection.myHub;

            // Create a function that the hub can call to broadcast messages.
            chat.client.addMessage = function (name, message) {
                if (name == nickName) {
                    var $meTemplate = $('#template_me');
                    $meTemplate.find('.message').html(message);
                    $('#chat_window').append($meTemplate.html());
                    //if ($('#chat_window div').length > 0)
                    //    $('#chat_window div').last().after($meTemplate.html());
                    //else $('#chat_window').append($meTemplate.html());

                }
                else {
                    var $opponentTemplate = $('#template_opponent');
                    $opponentTemplate.find('.message').html(message);
                    $('#chat_window').append($opponentTemplate.html());
                    //if ($('#chat_window div').length > 0)
                    //    $('#chat_window div').last().after($opponentTemplate.html());
                    //else $('#chat_window').append($opponentTemplate.html());
                }             
            };

            chat.client.findedGroup = function (groupName) {
                if (groupName == '' || groupName == undefined) {                    
                    alert('모든 상담원이 상담중입니다.');
                    locatin.href = './room_list.html'
                }
                else {
                    group = groupName;
                }
            };

            chat.client.changeGroupName = function (groupName) {
                group = groupName;
            }
            
            
            // Set initial focus to message input box.
            $('#message').focus();

            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.findGroup(nickName, clientId,categoryCd);
                $('#sendmessage').click(function (e) {
                    e.preventDefault();
                    // Call the Send method on the hub.
                    chat.server.send(nickName, $('#message').val(), group);
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });

            function getQueryParameter(parameterName) {
                var queryString = window.top.location.search.substring(1);
                var parameterName = parameterName + "=";
                if (queryString.length > 0) {
                    begin = queryString.indexOf(parameterName);
                    if (begin != -1) {
                        begin += parameterName.length;
                        end = queryString.indexOf("&", begin);
                        if (end == -1) {
                            end = queryString.length
                        }
                        return unescape(queryString.substring(begin, end));
                    }
                }
                return "null";
            }
        });
        
    </script>
</head>
<body>
<header id="header" class="fixed">
	<h1>고객행복센터</h1>
	<nav>
		<button type="button" class="btn-nav-toggle"><i class="fa fa-bars fa-lg"></i></button>
		<ul>
			<li><a href="#"><i class="fa fa-power-off"></i> 대화 종료하기</a></li>
			<li><a href="#"><i class="fa fa-envelope-o"></i> 메일로 보내기</a></li>
		</ul>
	</nav>
</header>

<!-- chat-window -->
<div class="chat-window" id="chat_window">
	
</div>
<div id="template_me" style="display:none">
    <div class="me">
		<div class="photo">
			<i class="fa fa-user"></i>
		</div>
		<div class="body">
			<div class="message">
				me me me me me me me me me me me
			</div>
			<div class="info">
				08:16 <i class="fa fa-check"></i>
			</div>
		</div>
	</div>
</div>
<div id="template_opponent" style="display:none">
    <div class="opponent">
        <div class="photo">
			<i class="fa fa-user"></i>
		</div>
        <div class="body">
			<div class="message">				
			</div>
			<div class="info">
				08:16 <i class="fa fa-check"></i>
			</div>
		</div>
    </div>
</div>
<!-- /chat-window -->
<!-- chat-form -->
<div class="chat-form">
	<div class="body">
		<form>
			<input type="text" id="message">
			<button type="submit" id="sendmessage">전송</button>
		</form>
	</div>
</div>
<!-- /chat-form -->
</body>
</html>